<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mi Plan - Tutoriales Web</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>Mi Plan de Aprendizaje</h1>
    <nav>
      <a href="perfil.html">← Volver a mi perfil</a>
    </nav>
  </header>
  
  <main>
    <article id="plan-content" class="container-medium">
      <p>Cargando plan...</p>
    </article>
  </main>
  
  <footer>
    <p>&copy; 2026 Tutoriales Web</p>
  </footer>

  <script>
    async function loadPlan() {
      try {
        // Check authentication
        const authRes = await fetch('/api/auth/me');
        const authData = await authRes.json();
        
        if (!authData.loggedIn) {
          window.location.href = 'registro.html';
          return;
        }
        
        // Load profile
        const profileRes = await fetch('/api/profile');
        const profileData = await profileRes.json();
        const profile = profileData.profile || {};
        
        if (!profile.onboarding) {
          window.location.href = 'onboarding.html';
          return;
        }
        
        const onboardingData = profile.onboarding;
        const userAreas = onboardingData.areas_to_improve || [];
        
        // Fetch tutorials and build plan
        const tutorialsRes = await fetch('/tutoriales/index.json');
        const tutorials = await tutorialsRes.json();
        
        const content = document.getElementById('plan-content');
        
        // Match tutorials by categories
        const matchedTutorials = tutorials.filter(tutorial => {
          return tutorial.categories.some(cat => userAreas.includes(cat));
        });
        
        // Fill with others if not enough matches
        let recommendedTutorials = matchedTutorials;
        if (recommendedTutorials.length < 3) {
          const remaining = tutorials.filter(t => !matchedTutorials.includes(t));
          recommendedTutorials = [...matchedTutorials, ...remaining].slice(0, 6);
        } else {
          recommendedTutorials = recommendedTutorials.slice(0, 6);
        }
        
        if (recommendedTutorials.length === 0) {
          content.innerHTML = `
            <p class="text-secondary">Aún no hay tutoriales disponibles para tus áreas de interés.</p>
            <button onclick="window.location.href='perfil.html'" class="btn-primary">
              Volver a mi perfil
            </button>
          `;
          return;
        }
        
        content.innerHTML = `
          <div class="info-box">
            <p class="text-secondary text-small">
              Este plan es una propuesta inicial basada en tus intereses. Ajusta cuando quieras.
            </p>
          </div>
          
          <h2 class="text-accent">Tutoriales recomendados</h2>
          
          <ul class="tutorial-list">
            ${recommendedTutorials.map(tutorial => `
              <li>
                <a href="tutorial.html?slug=${tutorial.slug}">
                  <strong>${tutorial.title}</strong>
                </a>
                <div class="tutorial-tags">
                  ${tutorial.categories.map(cat => 
                    `<span class="${userAreas.includes(cat) ? 'category-tag-active' : 'category-tag-inactive'}">${cat}</span>`
                  ).join('')}
                  ${tutorial.dev_time ? `<span class="dev-time-tag">Tiempo de desarrollo: ${tutorial.dev_time}</span>` : ''}
                </div>
                <p>${tutorial.description}</p>
              </li>
            `).join('')}
          </ul>
          
          <button onclick="window.location.href='perfil.html'" class="btn-primary">
            Volver a mi perfil
          </button>
        `;
      } catch (error) {
        console.error('Load plan error:', error);
        document.getElementById('plan-content').innerHTML = `
          <p class="text-danger">Error al cargar los tutoriales. Por favor, intenta más tarde.</p>
          <button onclick="window.location.href='perfil.html'" class="btn-primary">
            Volver a mi perfil
          </button>
        `;
      }
    }

    // Load plan on page load
    loadPlan();
  </script>
</body>
</html>
