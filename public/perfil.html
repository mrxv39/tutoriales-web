<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mi Perfil - Tutoriales Web</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>Mi Perfil</h1>
    <nav>
      <a href="index.html">← Volver al inicio</a>
    </nav>
  </header>
  
  <main>
    <article id="profile-content" class="container-narrow">
      <p>Cargando perfil...</p>
    </article>
  </main>
  
  <footer>
    <p>&copy; 2026 Tutoriales Web</p>
  </footer>

  <script>
    let currentUser = null;
    let currentProfile = null;

    // Check authentication and load profile
    async function loadProfile() {
      try {
        // Check if logged in
        const authRes = await fetch('/api/auth/me');
        const authData = await authRes.json();
        
        if (!authData.loggedIn) {
          window.location.href = 'registro.html';
          return;
        }
        
        currentUser = authData;
        
        // Load profile data
        const profileRes = await fetch('/api/profile');
        const profileData = await profileRes.json();
        
        currentProfile = profileData.profile || {};
        
        renderProfile();
      } catch (error) {
        console.error('Error loading profile:', error);
        document.getElementById('profile-content').innerHTML = `
          <p class="text-danger">Error al cargar el perfil. Por favor, intenta más tarde.</p>
        `;
      }
    }

    function renderProfile() {
      const content = document.getElementById('profile-content');
      const onboarding = currentProfile.onboarding;
      
      let onboardingSection = '';
      
      if (onboarding && onboarding.skill_level) {
        onboardingSection = `
          <div class="info-box-accent">
            <h3 class="text-accent">Tu cuestionario</h3>
            <p><strong>Nivel:</strong> ${onboarding.skill_level}</p>
            <p><strong>Áreas de interés:</strong> ${onboarding.areas_to_improve.join(', ')}</p>
            <p><strong>Tiempo semanal:</strong> ${onboarding.weekly_time}</p>
            <div class="flex-row">
              <button onclick="window.location.href='plan.html'" class="btn-primary">
                Ver mi plan
              </button>
              <button onclick="window.location.href='onboarding.html'" class="btn-secondary">
                Editar cuestionario
              </button>
            </div>
          </div>
        `;
      } else {
        onboardingSection = `
          <div class="info-box-warning">
            <p>Completa tu cuestionario para obtener un plan personalizado.</p>
            <button onclick="window.location.href='onboarding.html'" class="btn-primary">
              Completar cuestionario
            </button>
          </div>
        `;
      }
      
      const userName = currentProfile.name || currentUser.email.split('@')[0];
      
      content.innerHTML = `
        <div class="info-box">
          <h2 class="text-accent">Hola, ${userName}</h2>
          <p><strong>Email:</strong> ${currentUser.email}</p>
        </div>
        
        ${onboardingSection}
        
        <div class="flex-row">
          <button id="logout-btn" class="btn-primary">
            Cerrar sesión
          </button>
        </div>
      `;
      
      // Logout button
      document.getElementById('logout-btn').addEventListener('click', async function() {
        try {
          await fetch('/api/auth/logout', { method: 'POST' });
          window.location.href = 'index.html';
        } catch (error) {
          console.error('Logout error:', error);
          alert('Error al cerrar sesión');
        }
      });
    }

    // Load profile on page load
    loadProfile();
  </script>
</body>
</html>
